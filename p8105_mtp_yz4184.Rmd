---
title: "p8105_mtp_yz4184"
author: "Yunlin Zhou"
date: "10/28/2021"
output: html_document
---
```{r setup, include = FALSE}
library(tidyverse)
library(readxl)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# Problem 1

```{r}
# Import data

horns_df_ori = read_excel ("./p8105_mtp_data.xlsx", range = "A9:I1230")

# Clean the data

horns_df  = janitor::clean_names(horns_df_ori)

horns_df = horns_df %>%
  mutate(horns_df,
    sex = recode(sex, `0` = "female", `1` = "male"),
    sex = factor(sex, levels = c("female", "male")),
    age_group = recode(age_group, 
                       `1` = "18-",
                       `2` = "18-30",
                       `3` = "31-40",
                       `4` = "41-50",
                       `5` = "51-60",
                       `6` = "60+",
                       `7` = "60+",
                       `8` = "60+"),
      age_group = factor(age_group,levels = 
                              c("18-30",
                                "31-40",
                                "41-50",
                                "51-60",
                                "60+")),
    eop_size = recode(eop_size, 
                       `0` = "0-5",
                       `1` = "5-10",
                       `2` = "10-15",
                       `3` = "15-20",
                       `4` = "20-25",
                       `5` = "25+"),
    eop_size =factor(eop_size,
                           levels = 
                              c("0-5",
                                "5-10",
                                "10-15",
                                "15-20",
                                "20-25",
                                "25+")),
    eop_visibility_classification = recode(eop_visibility_classification, 
                       `0` = "0",
                       `1` = "0-5",
                       `2` = "5+"),
    eop_visibility_classification =
      factor(eop_visibility_classification, levels = c("0", "0-5", "5+")),
    fhp_category = recode(fhp_category,
                          `0` = "0-10",
                       `1` = "10-20",
                       `2` = "20-30",
                       `3` = "30-40",
                       `4` = "40-50"),
    fhp_category = factor(fhp_category, levels = c("0-10", "10-20", "20-30", "30-40", "40-50")),
    eop_size_mm = replace (eop_size_mm, 
                           is.na (eop_size_mm), 0))%>%
  relocate(sex, age_group)%>%
  arrange(sex,age)%>%
  filter(age_group != "18-")

```

### Describe the data cleaning process

According to the setting in the original table, I replaced the representative number with accurate range, and fill in missing values with data. Also I changed column names into lowercase letters and _. I relocated the column orders and reorder the rows by sex and age. 

### Describe the resulting dataset

```{r results='hide', echo = FALSE}

ncol(horns_df)

nrow(horns_df)

sex_num = count(horns_df,sex)
knitr::kable(sex_num)

age_num = count(horns_df, age_group)
knitr::kable(age_num)

```

There are `r ncol(horns_df) ` variables and `r nrow(horns_df) ` participants which included 614 female and 607 male. There are 2 people under 18, 303 people from 18 to 30, 204 people from 31 to 40, 207 people from 41 to 50, 200 people from 51 to 60 and 305 people above 60. The key vairaibles are sex, FHP and age.

### issues in the available data

```{r}
# In FHP category, there is a number not belonging to any group.

strange_fhp = horns_df_ori%>%
  janitor::clean_names()%>%
  mutate(fhp_category = as.numeric(fhp_category))%>%
  filter(fhp_category > 7)

# In EOP shape and FHP size there are missing values

missing_value = horns_df_ori%>%
  janitor::clean_names()%>%
  mutate( eop_shape_na = is.na(eop_shape),
          fhp_size_na = is.na(fhp_size_mm))%>%
  select(eop_shape, eop_shape_na, fhp_size_mm, fhp_size_na)

# In EOP Size, there is a number not belonging to any group.

strange_eop = horns_df_ori%>%
  janitor::clean_names()%>%
  mutate(eop_size = as.numeric(eop_size))%>%
  filter(eop_size > 5)

```


# Problem 2 

### FHP histogram

```{r}

fhp_his_plot = 
  horns_df %>%
  ggplot(aes(x = fhp_size_mm, fill = sex))+
  geom_histogram(position = "dodge", binwidth = 2)+ 
  labs(
    title = "FHP size histogram",
    x = "FHP size (mm)",
    y = "Different FHP size number"
  )

fhp_his_plot

```

### The rate of enlarged EOP in each age group

```{r}

rate_df = horns_df %>%
  count(age_group, sex, eop_size)

eop = rate_df%>%
  filter(eop_size%in%c("10-15","15-20","20-25","25+"))%>%
  group_by(age_group,sex)%>%
  summarise(eop_num = sum(n))

total = rate_df%>%
  group_by(age_group,sex)%>%
  summarise(total_num = sum(n))

rate_df = left_join(eop, total)%>%
  mutate(rate = eop_num/total_num,
         age_group_num = recode(age_group,
                                `18-30` = 1,
                                `31-40` = 2,
                                `41-50` = 3,
                                `51-60` = 4,
                                `60+` = 5))

rate_df_plot = ggplot(rate_df, aes(x = age_group_num, y = rate, color =sex))+
  geom_point()+
  geom_line()+
  labs(
    title = "The rate of enlarged EOP in each age group",
    x = "Age group (years)",
    y = "The rate of enlarged EOP"
  ) + 
  scale_x_continuous(
    labels = c("18-30", "31-40", "41-50", "51-60", "60+")
  ) 

rate_df_plot

```

### The association between FHP size and EOP size in each age and sex group

```{r fig.asp = 2}

eop_fhp = 
horns_df%>%
  filter(age_group != "18-")%>%
ggplot(aes(x = eop_size_mm, y = fhp_size_mm))+
  geom_point()+
  labs(
    title = "The association between FHP size and EOP size",
    x = "EOP size (mm)",
    y = "FHP size (mm)"
  ) + 
  scale_x_continuous(
    breaks = c(10, 20, 30),
    labels = c("10", "20", "30")
  )+
  facet_wrap(vars(sex,age_group), ncol = 2)

eop_fhp
```

# Problem 3

### Sample sizes in each age group

```{r}

sample_size_each = horns_df%>%count(age_group)
knitr::kable(sample_size_each)

sample_size = length(horns_df$sex)
print(sample_size)

sample_range = range(horns_df$age)
print(sample_range)

```

The sample size and range are approximately the same to that mentioned in article.

### Mean and standard deviations for FHP size

```{r}

# mean and sd of male
horns_df%>%
  filter(sex == "male")%>%
  select(fhp_size_mm)%>%
t.test(alternative = 'two.sided')

sd_male_df = horns_df%>%
  filter(sex == "male")%>%
  mutate(fhp_size_mm = replace(fhp_size_mm, is.na(fhp_size_mm),0))%>%
  select(fhp_size_mm)

sd_male = as.numeric(unlist(sd_male_df))%>%
  sd()%>%
  print()



# mean and sd of female

horns_df%>%
  filter(sex == "female")%>%
  select(fhp_size_mm)%>%
t.test(alternative = 'two.sided')

sd_female_df = horns_df%>%
  filter(sex == "female")%>%
  mutate(fhp_size_mm = replace(fhp_size_mm, is.na(fhp_size_mm),0))%>%
  select(fhp_size_mm)

sd_female = as.numeric(unlist(sd_female_df))%>%
  sd()%>%
  print()

```



### Definition of EEOP and variables to evaluate the claim

EEOP : EOP (external occipital protuberance) which exceeded 10 mm in size

eop_size and eop_size_mm could be used to evaluate the claim.

```{r}
# the prevalence of EEOP

eeop_num = horns_df%>%
  filter(eop_size %in% c("10-15", "15-20", "20-25", "25+"))%>%
  nrow()%>%
  print()

eeop_prev = (eeop_num/nrow(horns_df))%>%print()

```

### FHP in older subjects

```{r}
# The FHP trend

fhp_density = ggplot(horns_df, aes(x = fhp_size_mm, color = age_group))+
  geom_density()+
  labs(
    title = "Density of FHP size in different age group",
    x = "FHP size",
    y = "Density"
  )

fhp_density

```

```{r}

# FHP >40 mm rate in older subjects

FHP_num = horns_df%>%
  filter(fhp_size_mm > 40)%>%
  nrow()%>%
  print()

FHP_num_older = horns_df%>%
  filter(fhp_size_mm > 40,
         age_group == "60+")%>%
  nrow()%>%
  print()

fhp_older_rate = (FHP_num_older/FHP_num)%>%print()


```

